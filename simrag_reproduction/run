#!/usr/bin/env python3
"""
SimRAG CLI - Simple command line interface
Usage: python run <command>
"""

import os
import sys
import subprocess
from pathlib import Path


def get_python_cmd():
    """Get the correct Python command for the platform"""
    if os.name == 'nt':  # Windows
        return "venv\\Scripts\\python"
    else:  # Unix/Linux/Mac
        return "venv/bin/python"


def check_venv():
    """Check if virtual environment exists"""
    venv_path = Path("venv")
    if not venv_path.exists():
        print("Virtual environment not found!")
        print("Run: python run setup first")
        return False
    return True


def run_setup():
    """Run setup (create venv and install dependencies)"""
    print("Setting up environment...")
    
    # Create virtual environment
    if not Path("venv").exists():
        print("Creating virtual environment...")
        result = subprocess.run([sys.executable, "-m", "venv", "venv"], check=True)
        if result.returncode != 0:
            print("Failed to create virtual environment")
            return 1
        print("Virtual environment created")
    else:
        print("Virtual environment already exists")
    
    # Install dependencies
    python_cmd = get_python_cmd()
    print("Installing dependencies...")
    result = subprocess.run([python_cmd, "-m", "pip", "install", "--upgrade", "pip"], check=True)
    if result.returncode != 0:
        print("Failed to upgrade pip")
        return 1
    
    result = subprocess.run([python_cmd, "-m", "pip", "install", "-r", "requirements.txt"], check=True)
    if result.returncode != 0:
        print("Failed to install dependencies")
        return 1
    
    print("Dependencies installed")
    print("Setup completed!")
    return 0


def run_tests():
    """Run all tests"""
    if not check_venv():
        return 1
    
    python_cmd = get_python_cmd()
    print("Running tests...")
    
    try:
        result = subprocess.run([python_cmd, "-m", "pytest", "tests/", "-v"], check=True)
        print("All tests passed!")
        return 0
    except subprocess.CalledProcessError as e:
        print(f"Tests failed with exit code {e.returncode}")
        return e.returncode


def main():
    """Main CLI function"""
    if len(sys.argv) < 2:
        print(" SimRAG CLI")
        print("=" * 20)
        print("Usage: python run <command>")
        print("")
        print("Commands:")
        print("  setup  - Create venv and install dependencies")
        print("  test   - Run all tests")
        print("  help   - Show this help message")
        return 0
    
    command = sys.argv[1].lower()
    
    if command == "setup":
        return run_setup()
    elif command == "test":
        return run_tests()
    elif command == "help":
        print(" SimRAG CLI")
        print("=" * 20)
        print("Usage: python run <command>")
        print("")
        print("Commands:")
        print("  setup  - Create venv and install dependencies")
        print("  test   - Run all tests")
        print("  help   - Show this help message")
        return 0
    else:
        print(f"Unknown command: '{command}'")
        print("")
        print("Available commands: setup, test, help")
        print("Use 'python run help' for more information")
        return 1


if __name__ == "__main__":
    sys.exit(main())
